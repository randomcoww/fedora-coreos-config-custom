name: Image build
on:
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

env:
  FEDORA_VERSION: 42
  VARIANT: custom
  COSA_SUPERMIN_MEMORY: 4096

jobs:
  build:
    env:
      TAGS_KEEP: 4
    runs-on: builder-${{ github.event.repository.name }}
    container:
      image: reg.cluster.internal/randomcoww/coreos-assembler:latest
    permissions:
      contents: write
    steps:
    - name: Set tag
      run: |
        set -e
        TARGETARCH=$(arch)
        TARGETARCH=${TARGETARCH/x86_64/amd64} && TARGETARCH=${TARGETARCH/aarch64/arm64}

        echo "BUILD_TAG=${FEDORA_VERSION}.$(date -u +'%Y%m%d.%H')" | sudo tee -a "$GITHUB_ENV"
        echo TARGETARCH=$TARGETARCH | sudo tee -a "$GITHUB_ENV"

    - name: Setup MinIO
      run: |
        cd $HOME
        curl -fsSL -O https://dl.min.io/client/mc/release/linux-$TARGETARCH/mc
        chmod +x mc
        mkdir -p .mc/certs/CAs
        echo -e "$INTERNAL_CA_CERT" > .mc/certs/CAs/ca.crt

    - name: Build keepalived package
      run: |
        cd $HOME
        sudo dnf install -y --setopt=install_weak_deps=False \
          rpmdevtools \
          dnf-plugins-core \
          libnftnl-devel \
          unzip

        mkdir -p rpmbuild/
        cd rpmbuild
        git clone --depth 1 -b f$FEDORA_VERSION https://src.fedoraproject.org/rpms/keepalived.git SOURCES/
        cd SOURCES
        spectool -gR keepalived.spec
        sudo dnf builddep -y keepalived.spec
        rpmbuild -bb keepalived.spec \
          --without snmp \
          --with nftables \
          --without debug

        cd $HOME
        mkdir -p overrides/rpm
        cp -r rpmbuild/RPMS/$(arch)/. overrides/rpm/

    - name: Pull build
      run: |
        cd $HOME
        cosa init -V $VARIANT \
          --force ${{ github.server_url }}/${{ github.repository }}.git

    - name: Add internal CA
      run: |
        cd $HOME/src/config
        mkdir -p overlay.d/40custom/etc/pki/ca-trust/source/anchors
        echo -e "$INTERNAL_CA_CERT" > overlay.d/40custom/etc/pki/ca-trust/source/anchors/ca-cert.pem

    - name: Run fetch
      run: |
        cd $HOME
        cat > src/config/build-override.yaml <<EOF
        releasever: $FEDORA_VERSION

        ostree-layers:
          - overlay/40custom
        EOF

        cosa fetch --with-cosa-overrides

    - name: Run build
      run: |
        cd $HOME
        cosa build --version=$BUILD_TAG

    - name: Run buildextend-metal4k
      run: |
        cd $HOME
        cosa buildextend-metal4k

    - name: Run buildextend-metal
      run: |
        cd $HOME
        cosa buildextend-metal

    - name: Run buildextend-live
      run: |
        cd $HOME
        cosa buildextend-live

    - name: Push image
      run: |
        cd $HOME
        ./mc cp -r -q --no-color \
          builds/latest/x86_64/fedora-*-live* \
          arc/boot/

    - name: Create tag
      run: |
        cd $HOME/src/config
        git config --global user.email "${{ github.actor }}@users.noreply.github.com"
        git config --global user.name "${{ github.actor }}"
        git tag -a $BUILD_TAG -m "Build $BUILD_TAG"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
        git push origin $BUILD_TAG

    - name: Remove old images
      run: |
        cd $HOME
        tags=$(./mc ls --json --no-color arc/boot/fedora-coreos- | jq -r '.key' | sed -r 's/fedora-coreos-(.*)-live-.*$/\1/' | sort -u | head -n -$TAGS_KEEP)
        for tag in $tags; do
          ./mc rm -r -q --no-color --force arc/boot/fedora-coreos-$tag
        done