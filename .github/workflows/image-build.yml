# References:
# https://some-natalie.dev/blog/kaniko-in-arc/
# https://dev.to/ipo/using-kaniko-to-build-and-publish-container-image-with-github-action-on-github-self-hosted-runners-d5m

name: Image Build
on:
  workflow_dispatch:
  push:
    tags:
      - v*

jobs:
  build:
    runs-on: arc-runner-${{ github.event.repository.name }}
    container:
      image: quay.io/coreos-assembler/coreos-assembler:latest
    permissions:
      contents: read
      packages: write
    steps:
    - name: Build and release image
      run: |
        set -xe

        COSA_SUPERMIN_MEMORY=4096
        VARIANT=coreos

        curl https://dl.min.io/client/mc/release/linux-amd64/mc \
          --create-dirs -o $HOME/mc
        chmod +x $HOME/mc

        BUILD_PATH=$HOME/$VARIANT
        mkdir -p $BUILD_PATH
        cd $BUILD_PATH

        cosa init -V $VARIANT \
          --force ${{ github.server_url }}/${{ github.repository }}.git
        cosa clean
        cosa fetch
        cosa build metal4k
        cosa buildextend-metal
        cosa buildextend-live

        $HOME/mc cp -r -q --no-color \
          $BUILD_PATH/builds/latest/x86_64/fedora-*-live* \
          arc/data-boot/