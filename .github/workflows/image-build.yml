# References:
# https://some-natalie.dev/blog/kaniko-in-arc/
# https://dev.to/ipo/using-kaniko-to-build-and-publish-container-image-with-github-action-on-github-self-hosted-runners-d5m

name: Image Build
on:
  workflow_dispatch:
  push:
    tags:
      - v*

jobs:
  build:
    runs-on: arc-runner-${{ github.event.repository.name }}
    container:
      image: quay.io/coreos-assembler/coreos-assembler:latest
    permissions:
      contents: read
    steps:
    - name: Build and release image
      run: |
        set -xe
        ## build custom keepalived ##

        cd $HOME
        sudo dnf install -y --setopt=install_weak_deps=False \
          rpmdevtools \
          dnf-plugins-core \
          git-core \
          libnftnl-devel \
          createrepo

        mkdir -p rpmbuild/
        cd rpmbuild
        git clone -b f$(rpm -E %fedora) https://src.fedoraproject.org/rpms/keepalived.git SOURCES/
        cd SOURCES
        spectool -gR keepalived.spec
        sudo dnf builddep -y keepalived.spec
        rpmbuild -bb keepalived.spec \
          --without snmp \
          --with nftables \
          --without debug

        find $HOME/rpmbuild/RPMS/ -type d -mindepth 1 -maxdepth 1 -exec createrepo '{}' \;

        ## build image ##

        cd $HOME
        COSA_SUPERMIN_MEMORY=4096
        VARIANT=coreos

        curl https://dl.min.io/client/mc/release/linux-amd64/mc \
          --create-dirs -o mc
        chmod +x mc

        cosa init -V $VARIANT \
          --force ${{ github.server_url }}/${{ github.repository }}.git
        cosa clean
        cosa fetch
        cosa build metal4k
        cosa buildextend-metal
        cosa buildextend-live

        ## push ##

        cd $HOME
        curl https://dl.min.io/client/mc/release/linux-amd64/mc \
          --create-dirs -o mc
        chmod +x mc

        ./mc cp -r -q --no-color \
          builds/latest/x86_64/fedora-*-live* \
          arc/data-boot/