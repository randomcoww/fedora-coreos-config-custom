ref: fedora/${basearch}/coreos/testing-devel
include:
  - manifests/ignition-and-ostree.yaml
  - manifests/file-transfer.yaml
  - workstation-ostree-config/fedora-common-ostree-pkgs.yaml
  - workstation-ostree-config/fedora-common-ostree.yaml
  - workstation-ostree-config/fedora-common-ostree.yaml
  - workstation-ostree-config/gnome-desktop-pkgs.yaml

automatic-version-prefix: "${releasever}.<date:%Y%m%d>.dev"
mutate-os-release: "${releasever}"

initramfs-args:
  - --no-hostonly
  # We don't support root on NFS, so we don't need it in the initramfs. It also
  # conflicts with /var mount support in ignition because NFS tries to mount stuff
  # in /var/ and then ignition can't cleanly unmount it. For example:
  # https://github.com/dracutdevs/dracut/blob/1856ae95c873a6fe855b3dccd0144f1a96b9e71c/modules.d/95nfs/nfs-start-rpc.sh#L7
  # See also discussion in https://github.com/coreos/fedora-coreos-config/pull/60
  - --omit=nfs
  # Omit these since we don't use them
  - --omit=lvm
  - --omit=multipath
  - --omit=iscsi

ignore-removed-users:
  - root
ignore-removed-groups:
  - root
etc-group-members:
  - wheel
  - sudo
  - systemd-journal
  - adm

check-passwd:
  type: "file"
  filename: "workstation-ostree-config/passwd"
check-groups:
  type: "file"
  filename: "workstation-ostree-config/group"

default-target: graphical.target

# ⚠⚠⚠ ONLY TEMPORARY HACKS ALLOWED HERE; ALL ENTRIES NEED TRACKER LINKS ⚠⚠⚠
# See also the version of this in fedora-coreos.yaml
postprocess:
  # Users shouldn't be configuring `rpm-ostreed.conf`
  # https://github.com/coreos/fedora-coreos-tracker/issues/271
  - |
    #!/usr/bin/env bash
    set -xeuo pipefail
    cat > /tmp/rpm-ostreed.conf << 'EOF'
    # By default, this system has its OS updates managed by
    # `zincati.service`.  Changes made to this file may
    # conflict with the configuation of `zincati.service`.
    # See https://github.com/coreos/zincati for additional
    # information.

    EOF
    cat /usr/etc/rpm-ostreed.conf >> /tmp/rpm-ostreed.conf
    cp /tmp/rpm-ostreed.conf /usr/etc/rpm-ostreed.conf
    rm /tmp/rpm-ostreed.conf

  # This will be dropped once rpm-ostree because module-aware.
  # https://github.com/projectatomic/rpm-ostree/issues/1542#issuecomment-419684977
  # https://github.com/projectatomic/rpm-ostree/issues/1435
  - |
    #!/usr/bin/env bash
    set -xeuo pipefail
    for x in /etc/yum.repos.d/*modular.repo; do
      sed -i -e 's,enabled=[01],enabled=0,' ${x}
    done

  # Disable the default-enabled AuthorizedKeysFile directive so we can
  # override it in a config fragment
  # https://github.com/coreos/fedora-coreos-tracker/issues/139
  # https://bugzilla.redhat.com/1824913
  - |
    #!/usr/bin/env bash
    set -xeuo pipefail
    sed -i 's/^AuthorizedKeysFile[[:blank:]]/#&/' /etc/ssh/sshd_config

  # Enable systemd-resolved
  - |
    #!/usr/bin/env bash
    set -xeuo pipefail
    ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf

# This thing is crying out to be pulled into systemd, but that hasn't happened
# yet.  Also we may want to add to rpm-ostree something like arch negation;
# basically right now it doesn't exist on s390x.
# Anyways, it was requested by the Red Hat perf team for RHCOS, so we have it here.
# https://serverfault.com/questions/513807/is-there-still-a-use-for-irqbalance-on-modern-hardware
# https://access.redhat.com/solutions/41535
packages-x86_64:
  - irqbalance
packages-ppc64le:
  - irqbalance
packages-aarch64:
  - irqbalance

releasever: "32"

rojig:
  license: MIT
  name: fedora-coreos
  summary: Fedora CoreOS testing-devel

repos:
  - fedora-coreos-pool
  # these repos are there to make it easier to add new packages to the OS and to
  # use `cosa fetch --update-lockfile`; but note that all package versions are
  # still pinned
  - fedora
  - fedora-updates
  - fedora-modular
  - fedora-updates-modular

add-commit-metadata:
  fedora-coreos.stream: testing-devel

  etc-group-members:
    # Add the docker group to /etc/group
    # https://github.com/coreos/fedora-coreos-tracker/issues/2
    # This will be no longer needed when systemd-sysusers has been implemented:
    # https://github.com/projectatomic/rpm-ostree/issues/49
    - libvirt
  
  packages:
    - libvirt-daemon-kvm
    - ksmtuned